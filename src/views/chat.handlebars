<h1>Bienvenido al chat, <span id="userName"></span></h1>

<div id="groups">
    <h3>Grupos disponibles</h3>
    <ul>
        <li><button onclick="joinGroup('sala1')">Sala 1</button></li>
        <li><button onclick="joinGroup('sala2')">Sala 2</button></li>
        <li><button onclick="joinGroup('sala3')">Sala 3</button></li>
    </ul>
</div>

<div id="chatArea" style="display:none;">
    <h3 id="currentGroup"></h3>
    <div id="messages" style="border:1px solid #ccc; height:200px; overflow-y:auto;"></div>
    <input id="messageInput" type="text" placeholder="Escribe un mensaje...">
    <button onclick="sendMessage()">Enviar</button>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
    const socket = io();
    const username = sessionStorage.getItem('username');

    if (!username) {
        window.location.href = '/';
    } else {
        document.getElementById('userName').textContent = username;
    }

    let currentRoom = null;

    function joinGroup(room) {
        if (currentRoom === room) return;

        if (currentRoom) {
            socket.emit('leaveRoom', { room: currentRoom, username });
        }

        currentRoom = room;
        document.getElementById('currentGroup').textContent = 'Chat en ' + room;
        document.getElementById('chatArea').style.display = 'block';

        socket.emit('joinRoom', { room, username });
    }

    function sendMessage() {
        const message = document.getElementById('messageInput').value;
        if (message.trim() === '') return;
        socket.emit('messageSent', { room: currentRoom, username, message });
        document.getElementById('messageInput').value = '';
    }

    socket.on('messageReceived', (data) => {
        const div = document.createElement('div');
        div.textContent = `${data.username}: ${data.message}`;
        document.getElementById('messages').appendChild(div);
        // autoscroll
        const messagesEl = document.getElementById('messages');
        messagesEl.scrollTop = messagesEl.scrollHeight;
    });

    window.addEventListener('beforeunload', () => {
        if (currentRoom && username) {
            socket.emit('leaveRoom', { room: currentRoom, username });
        }
    });
</script>
